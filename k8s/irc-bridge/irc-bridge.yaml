#      .
#     / V\
#   / `  /
#  <<   |    Deployment YAML to deploy matrix-appservice-irc.
#  /    |    Make sure to update config and generate tokens in ConfigMaps!
#

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: matrix-irc-bridge-config
  namespace: ircbridge
data:
  config.yaml: |
    # Minimal bridge config. Add extra options from upstream sample config as needed.
    # See https://github.com/matrix-org/matrix-appservice-irc/blob/develop/config.sample.yaml
    
    homeserver:
      # Synapse URL reachable from this namespace.
      # url: "https://matrix.example.com"
      url: "http://ess-synapse.ess.svc.cluster.local:8008"
      domain: "example.com"

    ircService:
      mediaProxy:
        signingKeyPath: "/data/media-proxy-signing-key.jwk"
        ttlSeconds: 3600
        bindPort: 11111
        # Must match the public host exposed by the Ingress below.
        publicUrl: "https://irc-media.example.com"
      servers:
        irc.w3.org:
          name: "W3C IRC"
          port: 6679
          ssl: true
          botConfig:
            enabled: true
            nick: "ess-comm-ex"
          matrixClients:
            userTemplate: "@irc_$SERVER_$NICK"
            displayName: "$NICK"
          dynamicChannels:
            enabled: true
            published: false
            createAlias: true
            joinRule: public
            federate: true

    database:
      engine: "postgres"
      # Keep this in sync with the matrix-irc-bridge-postgres Secret values below.
      connectionString: "postgres://matrix_irc:matrix_irc_password@matrix-irc-bridge-postgres:5432/matrix_irc"

    ircClients:
      mode: "pool"

    connectionPool:
      redisUrl: "redis://matrix-irc-bridge-redis:6379/0"
      persistConnectionsOnShutdown: true

  appservice-registration-irc.yaml: |
    # WARNING: Make sure to update any changes here to the duplicate ConfigMap

    id: irc
    url: "http://matrix-irc-bridge.ircbridge.svc.cluster.local:8090"
    # Generate with `openssl rand -hex 32`
    as_token: "REPLACE_ME_AS_TOKEN"
    # Generate with `openssl rand -hex 32`
    hs_token: "REPLACE_ME_HS_TOKEN"
    sender_localpart: appservice-irc
    rate_limited: false
    namespaces:
      users:
        - exclusive: true
          regex: '@irc_.*:example.com'
      aliases:
        - exclusive: true
          regex: '#irc_.*:example.com'
    protocols:
      - irc

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: matrix-irc-bridge-registration
  # Change this to the namespace where Synapse runs.
  namespace: ess
data:
  appservice-registration-irc.yaml: |
    # Synapse must load this file via app_service_config_files.
    # WARNING: Make sure to update any changes here to the duplicate ConfigMap
    
    id: irc
    url: "http://matrix-irc-bridge.ircbridge.svc.cluster.local:8090"
    # Generate with `openssl rand -hex 32`
    as_token: "REPLACE_ME_AS_TOKEN"
    # Generate with `openssl rand -hex 32`
    hs_token: "REPLACE_ME_HS_TOKEN"
    sender_localpart: appservice-irc
    rate_limited: false
    namespaces:
      users:
        - exclusive: true
          regex: '@irc_.*:example.com'
      aliases:
        - exclusive: true
          regex: '#irc_.*:example.com'
    protocols:
      - irc

---
apiVersion: v1
kind: Secret
metadata:
  name: matrix-irc-bridge-postgres
  namespace: ircbridge
stringData:
  POSTGRES_DB: matrix_irc
  POSTGRES_USER: matrix_irc
  POSTGRES_PASSWORD: matrix_irc_password

---
apiVersion: v1
kind: Service
metadata:
  name: matrix-irc-bridge-postgres
  namespace: ircbridge
spec:
  selector:
    app: matrix-irc-bridge-postgres
  ports:
    - name: postgres
      port: 5432
      targetPort: 5432

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: matrix-irc-bridge-postgres
  namespace: ircbridge
spec:
  serviceName: matrix-irc-bridge-postgres
  replicas: 1
  selector:
    matchLabels:
      app: matrix-irc-bridge-postgres
  template:
    metadata:
      labels:
        app: matrix-irc-bridge-postgres
    spec:
      containers:
        - name: postgres
          image: postgres:16-alpine
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 5432
              name: postgres
          env:
            - name: POSTGRES_DB
              valueFrom:
                secretKeyRef:
                  name: matrix-irc-bridge-postgres
                  key: POSTGRES_DB
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: matrix-irc-bridge-postgres
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: matrix-irc-bridge-postgres
                  key: POSTGRES_PASSWORD
          volumeMounts:
            - name: postgres-data
              mountPath: /var/lib/postgresql/data
  volumeClaimTemplates:
    - metadata:
        name: postgres-data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 10Gi

---
apiVersion: v1
kind: Service
metadata:
  name: matrix-irc-bridge-redis
  namespace: ircbridge
spec:
  selector:
    app: matrix-irc-bridge-redis
  ports:
    - name: redis
      port: 6379
      targetPort: 6379

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: matrix-irc-bridge-redis
  namespace: ircbridge
spec:
  serviceName: matrix-irc-bridge-redis
  replicas: 1
  selector:
    matchLabels:
      app: matrix-irc-bridge-redis
  template:
    metadata:
      labels:
        app: matrix-irc-bridge-redis
    spec:
      containers:
        - name: redis
          image: redis:7-alpine
          imagePullPolicy: IfNotPresent
          args:
            - redis-server
            - --appendonly
            - "yes"
          ports:
            - containerPort: 6379
              name: redis
          volumeMounts:
            - name: redis-data
              mountPath: /data
  volumeClaimTemplates:
    - metadata:
        name: redis-data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 5Gi

---
apiVersion: v1
kind: Service
metadata:
  name: matrix-irc-bridge
  namespace: ircbridge
spec:
  selector:
    app: matrix-irc-bridge
  ports:
    - name: appservice
      port: 8090
      targetPort: appservice
    - name: media-proxy
      port: 11111
      targetPort: media-proxy

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: matrix-irc-bridge-media-proxy
  namespace: ircbridge
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  ingressClassName: traefik
  rules:
    - host: irc-media.example.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: matrix-irc-bridge
                port:
                  number: 11111
  tls:
    - hosts:
        - irc-media.example.com
      secretName: matrix-irc-bridge-media-proxy-tls

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: matrix-irc-bridge
  namespace: ircbridge
spec:
  replicas: 1
  selector:
    matchLabels:
      app: matrix-irc-bridge
  template:
    metadata:
      labels:
        app: matrix-irc-bridge
    spec:
      initContainers:
        - name: wait-for-redis
          image: busybox:1.36
          imagePullPolicy: IfNotPresent
          command:
            - /bin/sh
            - -lc
            - |
              set -eu
              until nc -z matrix-irc-bridge-redis 6379; do
                echo "waiting for redis..."
                sleep 2
              done
        - name: generate-media-proxy-signing-key
          image: matrixdotorg/matrix-appservice-irc:release-4.0.0
          imagePullPolicy: IfNotPresent
          command:
            - /bin/sh
            - -lc
            - |
              set -eu
              if [ ! -s /data/media-proxy-signing-key.jwk ]; then
                node /app/lib/generate-signing-key.js > /data/media-proxy-signing-key.jwk
              fi
          volumeMounts:
            - name: media-proxy-signing-key
              mountPath: /data
      containers:
        - name: matrix-irc-bridge
          image: matrixdotorg/matrix-appservice-irc:release-4.0.0
          imagePullPolicy: IfNotPresent
          command:
            - node
            - app.js
            - -p
            - "8090"
            - -c
            - /config/config.yaml
            - -f
            - /config/appservice-registration-irc.yaml
          ports:
            - name: appservice
              containerPort: 8090
            - name: media-proxy
              containerPort: 11111
          volumeMounts:
            - name: bridge-config
              mountPath: /config/config.yaml
              subPath: config.yaml
              readOnly: true
            - name: bridge-registration
              mountPath: /config/appservice-registration-irc.yaml
              subPath: appservice-registration-irc.yaml
              readOnly: true
            - name: media-proxy-signing-key
              mountPath: /data
      volumes:
        - name: bridge-config
          configMap:
            name: matrix-irc-bridge-config
            items:
              - key: config.yaml
                path: config.yaml
        - name: bridge-registration
          configMap:
            name: matrix-irc-bridge-config
            items:
              - key: appservice-registration-irc.yaml
                path: appservice-registration-irc.yaml
        - name: media-proxy-signing-key
          emptyDir: {}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: matrix-irc-bridge-pool
  namespace: ircbridge
spec:
  replicas: 1
  selector:
    matchLabels:
      app: matrix-irc-bridge-pool
  template:
    metadata:
      labels:
        app: matrix-irc-bridge-pool
    spec:
      initContainers:
        - name: wait-for-redis
          image: busybox:1.36
          imagePullPolicy: IfNotPresent
          command:
            - /bin/sh
            - -lc
            - |
              set -eu
              until nc -z matrix-irc-bridge-redis 6379; do
                echo "waiting for redis..."
                sleep 2
              done
      containers:
        - name: pool
          image: matrixdotorg/matrix-appservice-irc:release-4.0.0
          imagePullPolicy: IfNotPresent
          command:
            - node
            - lib/pool-service/IrcConnectionPool.js
          env:
            - name: REDIS_URL
              value: redis://matrix-irc-bridge-redis:6379/0
            - name: LOGGING_LEVEL
              value: info
            - name: METRICS_HOST
              value: 0.0.0.0
            - name: METRICS_PORT
              value: "7002"
          ports:
            - name: metrics
              containerPort: 7002
