apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "matrix-appservice-irc.fullname" . }}
  labels:
    {{- include "matrix-appservice-irc.componentLabels" (dict "context" . "component" "bridge") | nindent 4 }}
spec:
  replicas: {{ .Values.replicas }}
  selector:
    matchLabels:
      {{- include "matrix-appservice-irc.componentSelectorLabels" (dict "context" . "component" "bridge") | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "matrix-appservice-irc.componentSelectorLabels" (dict "context" . "component" "bridge") | nindent 8 }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
        checksum/registration-tokens: {{ include (print $.Template.BasePath "/registration-token-secret.yaml") . | sha256sum }}
        checksum/media-proxy-signing-key: {{ include (print $.Template.BasePath "/media-proxy-signing-key-secret.yaml") . | sha256sum }}
    spec:
      {{- if .Values.podSecurityContext.enabled }}
      securityContext:
        {{- toYaml (omit .Values.podSecurityContext "enabled") | nindent 8 }}
      {{- end }}
      {{- if and .Values.redis.enabled .Values.waitForRedis.enabled }}
      initContainers:
        - name: wait-for-redis
          image: {{ include "matrix-appservice-irc.waitForRedisImage" . }}
          imagePullPolicy: {{ .Values.waitForRedis.image.pullPolicy }}
          {{- if .Values.securityContext.enabled }}
          securityContext:
            {{- toYaml (omit .Values.securityContext "enabled") | nindent 12 }}
          {{- end }}
          command:
            - /bin/sh
            - -lc
            - |
              set -eu
              until nc -z {{ include "matrix-appservice-irc.waitForRedisHost" . }} {{ .Values.waitForRedis.port }}; do
                echo "waiting for redis..."
                sleep {{ .Values.waitForRedis.sleepSeconds }}
              done
      {{- end }}
      containers:
        - name: {{ include "matrix-appservice-irc.name" . }}
          image: {{ include "matrix-appservice-irc.image" . }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command:
            - node
            - app.js
            - -p
            - {{ .Values.service.appservicePort | quote }}
            - -c
            - /config/config.yaml
            - -f
            - /config/appservice-registration-irc.yaml
          ports:
            - name: appservice
              containerPort: {{ .Values.service.appservicePort }}
            - name: media-proxy
              containerPort: {{ .Values.mediaProxy.bindPort }}
          {{- if .Values.securityContext.enabled }}
          securityContext:
            {{- toYaml (omit .Values.securityContext "enabled") | nindent 12 }}
          {{- end }}
          {{- with .Values.bridge.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          volumeMounts:
            - name: bridge-config
              mountPath: /config/config.yaml
              subPath: config.yaml
              readOnly: true
            - name: bridge-registration
              mountPath: /config/appservice-registration-irc.yaml
              subPath: appservice-registration-irc.yaml
              readOnly: true
            - name: media-proxy-signing-key
              mountPath: {{ .Values.mediaProxy.signingKeyPath }}
              subPath: {{ .Values.mediaProxy.signingKeySecretKey }}
              readOnly: true
      volumes:
        - name: bridge-config
          configMap:
            name: {{ include "matrix-appservice-irc.configMapName" . }}
            items:
              - key: config.yaml
                path: config.yaml
        - name: bridge-registration
          configMap:
            name: {{ include "matrix-appservice-irc.configMapName" . }}
            items:
              - key: appservice-registration-irc.yaml
                path: appservice-registration-irc.yaml
        - name: media-proxy-signing-key
          secret:
            secretName: {{ include "matrix-appservice-irc.mediaProxySigningKeySecretName" . }}
            items:
              - key: {{ .Values.mediaProxy.signingKeySecretKey | quote }}
                path: {{ .Values.mediaProxy.signingKeySecretKey | quote }}
