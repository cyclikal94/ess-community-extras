name: Rebuild Helm Chart Index

on:
  workflow_dispatch:
    inputs:
      prune_deleted_charts:
        description: "Remove index entries for charts no longer present under charts/."
        required: false
        default: true
        type: boolean

permissions:
  contents: write

concurrency:
  group: rebuild-helm-chart-index
  cancel-in-progress: false

jobs:
  rebuild-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git author
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Rebuild docs/index.yaml from releases
        uses: helm/chart-releaser-action@v1.6.0
        with:
          skip_packaging: true
          skip_upload: true
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          CR_PAGES_BRANCH: "main"
          CR_PAGES_INDEX_PATH: "docs/index.yaml"

      - name: Prune removed chart entries
        if: ${{ inputs.prune_deleted_charts }}
        run: |
          ruby <<'RUBY'
          require "set"
          require "yaml"

          index_path = "docs/index.yaml"
          abort("Missing #{index_path}") unless File.exist?(index_path)

          index = YAML.safe_load(File.read(index_path), aliases: true) || {}
          entries = index["entries"]
          unless entries.is_a?(Hash)
            puts "No entries map found; skipping prune."
            exit 0
          end

          active_chart_names = Dir.glob("charts/*/Chart.yaml").filter_map do |chart_file|
            chart = YAML.safe_load(File.read(chart_file), aliases: true) || {}
            name = chart["name"].to_s.strip
            name.empty? ? nil : name
          rescue Psych::SyntaxError => error
            warn "Skipping #{chart_file}: #{error.message}"
            nil
          end.to_set

          removed = entries.keys.reject { |name| active_chart_names.include?(name) }
          if removed.empty?
            puts "No stale chart entries found."
            exit 0
          end

          removed.each { |name| entries.delete(name) }
          File.write(index_path, YAML.dump(index))

          puts "Removed stale chart entries: #{removed.join(", ")}"
          RUBY

      - name: Commit pruned index
        if: ${{ inputs.prune_deleted_charts }}
        run: |
          if git diff --quiet -- docs/index.yaml; then
            echo "No post-rebuild changes to commit."
            exit 0
          fi

          git add docs/index.yaml
          git commit -m "chore: prune stale chart entries from docs index"
          git push origin HEAD:${GITHUB_REF_NAME}
